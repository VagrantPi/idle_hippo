# 📄 Step 12 規格書（省電掛機模式）

## 1. 階段目標
- 在**首頁 → 設定**中新增「省電掛機」入口按鈕（帶圓形外框，icon：`assets/images/icon/SavePower.png`）。
- 進入省電模式後顯示**黑底掛機畫面**：時鐘、月亮圖示、提示文案「觸控退出」（i18n），並於右上提供**直/橫切換**按鈕（帶圓形外框，icon：`assets/images/icon/Rotation.png`）。
- 省電模式下**維持前台**、**放置收益持續累積**、畫面更新頻率/亮度下降以節電。
- 退出省電模式後**穩定回到主畫面**，無閃屏、不卡頓，且**不觸發離線**流程。

---

## 2. 功能需求

### 2.1 入口與導覽
1. **設定頁新增入口**  
   - 位置：首頁右側功能列 → 設定（已於 Step 4）  
   - 元件：圓形外框按鈕 + icon `assets/images/icon/SavePower.png`，文案 i18n：`settings.power_save`  
   - 點擊後切換至**省電掛機畫面**（覆蓋式 Route / Overlay，不銜接系統休眠）

2. **返回邏輯**  
   - 省電畫面任意處「觸控退出」（單擊整個畫布）→ 關閉省電畫面並回到主畫面  
   - 退出時不觸發任何離線結算或重算 delta

### 2.2 省電掛機畫面（UI/布局）
1. **背景**：純黑（#000）全屏  
2. **右上角切換按鈕**：圓形外框 + icon `assets/images/icon/Rotation.png`  
   - 點擊可在**直式/橫式**兩種布局間切換（不改系統方向，僅切換組件排列），記錄於記憶體（離開省電畫面可重置）  
3. **版面（直式）**  
   - 置中縱向堆疊：  
     - **時鐘**（HH:mm:ss，24h，使用系統時區）  
     - **月亮圖**：`assets/images/icon/Moon.jpg`（適應寬度、保留 1:1）  
     - **提示文案**：i18n `power_save.tap_to_exit`（半透明白字）  
4. **版面（橫式）**  
   - 置中**橫向**：左側時鐘、右側月亮圖，下方置中提示文案  
5. **點擊回饋**  
   - 輕微縮放或波紋（不強制，可簡化為無回饋）  
6. **字型/可讀性**  
   - 時鐘字體大（≥ 48sp）、提示文案次要（≥ 16sp），對比 AA

### 2.3 節能策略
1. **亮度降低**  
   - 優先嘗試使用套件（如 `screen_brightness`）設定臨時亮度至 10%（範圍 0.05~0.15 可配置）  
   - 若裝置/權限不允許，退而求其次：加一層全屏半透明黑遮罩（例如 `rgba(0,0,0,0.85)`）  
   - 離開省電畫面時恢復原亮度（或移除遮罩）
2. **刷新頻率降檔**  
   - 省電畫面內**不訂閱 GameClock 每幀更新**，僅以 1Hz 計時器更新時鐘（或每 0.5Hz）  
   - 隱藏所有非必要動畫（無粒子、無過場）
3. **GPU/重繪控制**  
   - 畫面為純色與靜態圖，避免陰影/模糊等昂貴效果

### 2.4 與系統/遊戲循環的關係
1. **維持前台**：省電畫面是前台 Overlay，不改變 `AppLifecycleState`；**不得**使 App 進入 `paused/inactive`  
2. **放置收益**：沿用 Step 8 的前台 `onTick` 累積；省電畫面**不停止** onTick（或僅 UI 不重繪）  
3. **禁止離線觸發**：  
   - 省電畫面開啟/關閉**絕不**寫入 `offline.lastExitUtcMs` 或 `idle_rate_snapshot`  
   - Step 10/11 的 `_onResumed()` **不應**在省電畫面開/關時被誤觸  
4. **互動限制**：省電畫面中禁用其他 UI 互動（不切頁、不點功能），僅保留「旋轉」與「觸控退出」

### 2.5 i18n 文案
新增於 `assets/lang/{en,zh,jp,ko}.json`：
```json
{
  "settings.power_save": {"en":"Power Save","zh":"省電掛機","jp":"省電モード","ko":"절전 모드"},
  "power_save.tap_to_exit": {
    "en":"Tap anywhere to exit",
    "zh":"觸控退出",
    "jp":"画面をタップして終了",
    "ko":"화면을 터치하여 종료"
  },
  "power_save.orientation.portrait": {"en":"Portrait","zh":"直式","jp":"縦向き","ko":"세로"},
  "power_save.orientation.landscape": {"en":"Landscape","zh":"橫式","jp":"横向き","ko":"가로"}
}
````

### 2.6 資產

* 入口 icon：`assets/images/icon/SavePower.png`（圓形外框）
* 旋轉 icon：`assets/images/icon/Rotation.png`（圓形外框）
* 月亮圖：`assets/images/icon/Moon.jpg`

### 2.7 Debug / 安全

* Debug 面板顯示：`powerSave=on/off`、`orientation=portrait/landscape`、`brightnessOverride` 使用與否
* 任何亮度 API 失敗時記錄警告並自動套用黑遮罩方案
* 進出省電畫面需有**一次性 guard**，避免多重 push 導致重疊

---

## 3. 驗收標準

* ✅ **放置累積**：省電模式下，保持前台 30 秒時，資源增加量 ≈ `30 × idle_per_sec`（與 Step 8 同誤差範圍 ≤1%）
* ✅ **穩定進出**：從設定進入/觸控退出返回主畫面，全程無閃屏、無殘影、無 UI 狀態錯亂
* ✅ **不觸發離線**：進出省電畫面不會呼叫離線結算；退出後不彈離線彈窗
* ✅ **直/橫切換**：點右上按鈕可切換直式/橫式佈局，切換過程不卡頓
* ✅ **亮度下降**：進入時亮度明顯下降（系統亮度或黑遮罩），離開時恢復

---

## 4. 實例化需求測試案例

### 案例 1：放置持續累積

* **Given** `idle_per_sec=1.0`
* **When** 進入省電模式停留 30 秒
* **Then** 資源增加 ≈ `30 ± 0.3`

---

### 案例 2：不觸發離線

* **Given** 目前 `offline.lastExitUtcMs` 為某時間
* **When** 進入省電模式 20 秒 → 退出
* **Then** 未出現離線彈窗；`lastExitUtcMs` 未被更新為剛才 20 秒前的時間

---

### 案例 3：穩定進出

* **Given** 主畫面顯示正常
* **When** 連續 5 次「進入省電 → 觸控退出」
* **Then** 無閃屏、無黑屏停留、回主畫面資源/按鈕狀態正確

---

### 案例 4：直橫切換

* **Given** 省電畫面（直式）
* **When** 點擊右上旋轉按鈕 3 次
* **Then** 直/橫在兩種布局間切換，時鐘與月亮圖/提示位置符合設計，無縮放變形

---

### 案例 5：亮度回復

* **Given** 進入省電模式（亮度下調或黑遮罩）
* **When** 觸控退出
* **Then** 亮度恢復至進入前的狀態（或移除遮罩），不殘留暗屏效果

---

## 5. 限制與備註

* **不可改變 App Lifecycle**：省電僅是前台 UI 層；不得觸發 `paused/inactive`。
* 若裝置不允許調整系統亮度，需自動使用**黑遮罩**方案並在 Debug 記錄警告。
* GameClock 與放置累積照常運作；只降低 UI 更新頻率。
* 省電畫面不顯示任何會大量重繪的動畫（含粒子/陰影/模糊）。
* 直/橫切換為**布局切換**，不強制旋轉系統方向（避免跳動/閃屏）。
* 之後若要加入「螢幕常亮」可選項（避免裝置自動鎖屏），需評估權限與耗電影響（本階段非必須）。
