# 📄 Step 8 規格書（放置玩法 v1：前台累積）

## 1. 階段目標
- 在**前台狀態**下以固定速率累積資源：`idle_per_sec`（每秒放置收益）。
- 於 `GameClock` 的 `onTick(deltaSeconds)` 中定期結算，前台累積、背景不累積。
- 結算行為平滑且可配置（每秒或更細時間步長），不影響效能與手感。

---

## 2. 功能需求
1. **來源設定**
   - 自 `assets/config/game.json` 讀取：
     - `idle.base_per_sec`（基礎放置收益，預設例如 0.1）
     - `idle.multiplier`（全域放置倍率，預設 1.0，後續可被裝備/寵物/BUFF 疊加）
   - 透過 `ConfigService.getValue("game.idle.base_per_sec")` 等 API 取得，支援熱載。

2. **前台累積規則**
   - 依 Step 3 的 `GameClock` 訂閱 `onTick(deltaSeconds)`。
   - 僅在 App `resumed`（前台）時推進放置收益。
   - 每幀累加暫存：`idleAcc += idle_per_sec * deltaSeconds`。
   - 當 `idleAcc >= unit` 時結算到 `memePoints`（見「結算單位」），並將 `idleAcc` 減去已結算量；避免浮點誤差（採用 double 累積）。

3. **結算單位與模式**
   - 預設 **即時結算**：`unit = 0`（任何累積即刻入帳，顯示四捨五入）。
   - 可切換 **固定單位**（選配，預設關閉）：例如 `unit = 0.1`，聚合到達單位才入帳，降低頻繁寫 UI。
   - Debug 面板可動態切換 `unit` 以觀察差異（不屬於正式遊玩）。

4. **數值計算**
   - 當前放置速率：
     ```
     idle_per_sec = idle.base_per_sec
                    * idle.multiplier
                    * (1 + sum(裝備放置加成))  // 本階段可先不接裝備，預留欄位
                    * (1 + sum(寵物/BUFF加成)) // 之後階段接入
     ```
   - 本階段至少保障 `idle.base_per_sec` 能生效；其餘項可先返回 0 或 1（不影響）。

5. **UI**
   - 主資源顯示即時更新。
   - （選配）於資源區旁顯示 `+X/s` 指示（四捨五入顯示小數 1 位），與實際累積對齊。

6. **效能與安全**
   - 夾制單幀最大 `deltaSeconds = 0.2`（沿用 Step 3）。
   - 浮點誤差控制：顯示與內部累積分離，內部用 double 保留小數。
   - 背景狀態不累積；回前台第一幀將 `lastTick` 重置以避免爆量（已於 Step 3 定義）。

7. **存檔**
   - 本階段僅在定期（如每 3~5 秒）或重要節點（切頁/退到背景）寫入 `memePoints`，避免每幀寫檔。
   - 使用 Step 2 的 `SecureSaveService`；故障時不得阻塞遊戲主迴圈。

8. **Debug 面板**
   - 顯示：`idle.base_per_sec`、`idle_per_sec(effective)`、`idleAcc`、`unit`、`foreground=true/false`。
   - 提供「+倍率×2 / ×0.5」測試開關（僅 Debug）以觀察效果。

---

## 3. 驗收標準
- ✅ **前台累積**：設定 `idle_per_sec = 1.0`，於前台靜置 30 秒，資源介於 `29.7 ~ 30.3`（誤差 ≤ 1%）。
- ✅ **背景不累積**：切至背景 10 秒後回前台，總資源增加量不包含背景時間。
- ✅ **熱載生效**：修改 `idle.base_per_sec` 後（不重啟），放置速率立即反映在後續累積。
- ✅ **穩定更新**：連續 5 分鐘前台運行無顯著掉幀或數值跳躍（無短時間爆量或倒退）。

---

## 4. 實例化需求測試案例

### 案例 1：30 秒驗證
- **Given** `idle.base_per_sec = 1.0`、`multiplier = 1.0`、前台  
- **When** 不操作等待 30 秒  
- **Then** 資源落在 `30 ± 0.3`

---

### 案例 2：背景暫停
- **Given** `idle_per_sec = 2.0`  
- **When** 前台等 5 秒 → 背景 10 秒 → 回前台等 5 秒  
- **Then** 總增加 ≈ `5*2 + 5*2 = 20`，不計背景 10 秒

---

### 案例 3：結算單位切換（Debug）
- **Given** `idle_per_sec = 1.5`、`unit = 0.1`  
- **When** 連續前台 10 秒  
- **Then** `memePoints` 的可視更新為 0.1 階梯，但總量 ≈ `15 ± 0.15`

---

### 案例 4：熱載速率
- **Given** 初始 `idle.base_per_sec=0.5`  
- **When** 熱載修改為 `1.0`  
- **Then** 修改後的後續累積以 1.0/s 進行（前後區段差異可在 Debug 面板觀察）

---

## 5. 限制與備註
- 依 Step 3 的 delta 夾制與前/後台偵測；嚴禁在背景時累積。
- 本階段不含「離線收益」與「放置裝備/寵物加成」的實作；留待後續階段接入同一條公式。
- UI 更新頻率建議 ≤ 10 次/秒（節流），但內部累積可每幀進行。
- 寫檔節流：避免每幀保存，建議使用節流計時或變更量達門檻再保存。
