# 📄 Step 13 規格書（任務條：每日任務）

## 1. 階段目標
- 在主畫面上方顯示「任務條」（任務類型 + 進度 / 目標）。
- 任務採**單條輪替制**：完成即刻刷新下一個，**當日最多 10 個**。
- 任務型別固定兩種交替：
  1) **點擊 50 次**  
  2) **累積點數 ≥ X**（X = `idlePerSec_snapshot * 60 * 10`，即「10 分鐘」的放置收益量）
- 每個任務完成時給對應獎勵：`[1, 2, 3, 5, 8, 13, 21, 34, 55, 89]`（依當日完成順序）。
- **跨日（Asia/Taipei）自動重置**：任務序號回到第 1 個，今日完成數清 0，重新從類型 ① 開始。

---

## 2. 功能需求

### 2.1 UI 與顯示
- 位置：主畫面上方（Step 4 預留區），固定橫條。
- 內容：
  - 任務類型圖示（可佔位）：`TAP` 或 `累積`
  - 文案（i18n）：`{taskTitle} {progress}/{target}`
  - 右側完成按鈕（若「自動領取」可隱藏；本階段採**自動領取**）
- 完成時：播放簡短特效（高亮/打勾），0.5s 內切入**下一個**任務。

### 2.2 任務輪替與生成
- 今日任務序列（索引從 1 到 10）：
  - **奇數序**：任務 A =「點擊 50 次」
  - **偶數序**：任務 B =「累積點數 ≥ X」
- 生成時機：
  - 遊戲啟動 / 跨日後 / 前一個任務完成 → 生成下一個任務。
- **X 的計算**（僅對 B 類）：
  - 在**生成該任務的瞬間**記錄 `idlePerSec_snapshot = current_idle_per_sec`（整合 Step 8 + Step 9）。
  - `targetX = idlePerSec_snapshot * 600`（600 秒=10 分鐘）。
  - 目標值**固定**於任務生命期內，不因後續升級/倍率變更而改動（防止玩家中途變更造成體驗不一致）。

### 2.3 進度計數與來源
- **A 類（點擊 50 次）**：
  - 進度來源：**有效點擊事件數**（通過 Step 5 的冷卻判定即可計數）。
  - **不受每日點擊上限（Step 6）限制**：達上限雖不加分，但仍記入任務進度（避免卡死）。
- **B 類（累積點數 ≥ X）**：
  - 進度來源：**當前任務開始後的「淨新增資源」**（tap + idle + 其他來源的加總；**扣除消費不倒扣**）。
  - 計算方式：
    - 任務生成時記錄 `memePointsBaseline = currentMemePoints`；
    - 進度 = `max(0, currentMemePoints - memePointsBaseline + earnedSinceBaseline)`  
      > 簡化實作：每次資源增加事件（tap/idle結算/離線領取）時，將該「正向增量」累加到 `accumulateEarned`；顯示進度 = `accumulateEarned`。  
      > 支出（升級扣費）**不影響**進度。
  - 離線收益（Step 10/11）若在任務期間入帳，視為正向增量，**可計入**。

### 2.4 完成與獎勵
- 當 `progress >= target`：
  - 立即判定完成，播放完成特效。
  - 根據今日完成序號 `n`（1~10）發放對應獎勵：  
    `rewards = [1,2,3,5,8,13,21,34,55,89]`，給 `rewards[n-1]`。
  - **自動領取**：即刻將獎勵加入 `memePoints`（避免卡住流程）。
  - `todayCompleted += 1`；若 `<10`，立刻生成下一個；若已達 10，將任務條顯示為「今日任務已全部完成」的靜態狀態。

### 2.5 存檔資料結構（整合 Step 2）
在 `game_state_v{save_version}` 內新增：
```json
{
  "dailyMission": {
    "date": "2025-08-24",        // Asia/Taipei 今日字串
    "index": 1,                  // 今日第幾個任務(1~10)
    "type": "tap50|accumulateX", // 當前任務型別
    "progress": 0.0,             // 目前進度（A: 次數, B: 點數）
    "target": 0.0,               // 目標（A: 50, B: X）
    "idlePerSecSnapshot": 0.0,   // 僅 B 類使用
    "todayCompleted": 0          // 今日已完成任務數(0~10)
  }
}
````

### 2.6 跨日規則（Asia/Taipei）

* 每次任務事件/啟動 App/回前台時，取 Asia/Taipei 當日字串 `YYYY-MM-DD`。
* 若與存檔 `dailyMission.date` 不同 → **重置**：

  * `date = today`, `index = 1`, `todayCompleted = 0`
  * 生成**第 1 個**任務（A 類），`target=50`，`progress=0`
* 與 Step 6 的跨日機制一致，但**獨立紀錄**（兩者互不干涉）。

### 2.7 事件對接

* 監聽以下事件以推進進度：

  * `onValidTap()`（通過冷卻的有效點擊）：若 A 類 → `progress += 1`
  * `onEarnPoints(delta)`（任意正向得分事件：tap有效加分、idle結算、離線領取、任務獎勵自身除外）：

    * 若 B 類 → `progress += delta`
* 每次進度更新後，觸發完成檢查；完成則按 2.4 流程。

### 2.8 i18n 文案（最少鍵）

```json
{
  "mission.bar.title.tap": {
    "en":"Tap 50 times",
    "zh":"點擊 50 次",
    "jp":"50回タップ",
    "ko":"50회 탭"
  },
  "mission.bar.title.acc": {
    "en":"Gain ≥ {points}",
    "zh":"累積點數 ≥ {points}",
    "jp":"ポイント累積 ≥ {points}",
    "ko":"포인트 누적 ≥ {points}"
  },
  "mission.bar.done_today": {
    "en":"All 10 daily missions completed",
    "zh":"今日 10 個任務已完成",
    "jp":"本日の10個ミッションは完了",
    "ko":"오늘 10개 미션 완료"
  }
}
```

### 2.9 Debug / Telemetry（選配）

* Debug 面板顯示：`type/index/todayCompleted/progress/target/idlePerSecSnapshot/date(tz=Asia/Taipei)`。
* 快捷：`完成當前任務`、`模擬跨日`、`給資源+100`。
* 事件（GA4 後續）：`mission_start{type,target}`, `mission_progress{type,progress}`, `mission_complete{n,reward}`。

---

## 3. 驗收標準

* ✅ **輪替邏輯**：任務依序在「點擊 50 次」與「累積點數 ≥ X」間**交替**，完成一個即刷新下一個；**當日最多 10 個**。
* ✅ **X 設定**：B 類任務的 `X = idlePerSec * 60 * 10`，以**生成瞬間**的 `idlePerSec` 為快照；完成前不隨後續等級變更而變。
* ✅ **跨日重置**：當前已完成到第 5 個任務，**跨日後**重新打開任務欄 → 重置為**第一個任務（點擊 50 次）**，今日完成數歸 0。
* ✅ **獎勵正確**：依完成序號發放 `[1,2,3,5,8,13,21,34,55,89]`；完成第 n 個即得對應獎勵。
* ✅ **計數規則**：

  * A 類：通過冷卻的有效點擊皆計數；即使已達每日點擊上限也能計數（但不上分）。
  * B 類：僅計入**正向獲得**之點數（tap/idle/離線）；支出不倒扣。

---

## 4. 實例化需求測試案例

### 案例 1：輪替驗證

* **Given** 今日初次進入
* **When** 完成「點擊 50 次」
* **Then** 立即刷新為「累積點數 ≥ X」
* **When** 完成該任務
* **Then** 刷新為下一個「點擊 50 次」

---

### 案例 2：X 計算快照

* **Given** 生成 B 類任務瞬間 `idlePerSec=0.6/s` → `X=0.6*600=360`
* **When** 途中升級裝備使 `idlePerSec=1.0/s`
* **Then** 此任務目標仍為 `360`，不變

---

### 案例 3：到第 5 個任務後跨日

* **Given** 今日已連續完成 4 個，正在第 5 個（任務條顯示中）
* **When** 系統時間跨越 Asia/Taipei 新的一天
* **Then** 任務欄重置：`index=1`、`todayCompleted=0`、顯示「點擊 50 次」

---

### 案例 4：A 類與每日上限

* **Given** 今日點擊已達 Step 6 上限，不再加分
* **When** 進行 A 類任務
* **Then** 點擊仍計數，完成後能刷新下一個任務

---

### 案例 5：B 類僅計正向增量

* **Given** B 類任務目標 `X=200`
* **When** 先從離線領取 +100，再前台 idle 累積 +120，期間升級花費 -150
* **Then** 任務進度計為 `100 + 120 = 220 ≥ 200`（支出不倒扣），任務完成並發獎

---

### 案例 6：完成獎勵序列

* **Given** 連續完成 1\~3 個任務
* **When** 檢查 `memePoints` 變化
* **Then** 依序發放 `+1, +2, +3`；完成第 10 個時應發放 `+89`

---

## 5. 限制與備註

* 日界線固定 `Asia/Taipei`，以字串日期比對，與 Step 6 機制一致但資料區塊獨立。
* X 取 **生成瞬間的 idlePerSec**，避免動態波動造成體驗混亂；顯示以四捨五入到整數或 1 位小數（UI 決策）。
* 自動領取避免卡 UI；若日後改成手動領取，需避免領取本身被計入 B 類進度（可設置標記）。
* 底層事件請確保只對**正向得分**觸發 B 類累加；升級扣費等不應影響進度。
* 任務條為**單一進程**（不併行多條），完成數達 10 後顯示靜態完成狀態直到跨日重置。
