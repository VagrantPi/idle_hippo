# 📄 Step 16 規格書（寵物抽獎券目標：兩天公式）

## 1. 階段目標
- 建立 **寵物抽獎券任務系統**，作為每日任務之外的獨立任務區塊。
- 寵物獲取途徑僅能透過「抽獎券任務」獲得。
- 任務於完成 **主線動物迷因階段（mainline.stage3）** 後解鎖。
- 任務完成時，玩家需手動點擊「領取」才獲得抽獎券，並可選擇觀看廣告翻倍。
- 抽獎券數量顯示於首頁，帶有「彩票 icon」。

---

## 2. 功能需求

### 2.1 任務解鎖
- 當 `mainQuest.currentStage >= 3`（動物迷因階段完成）時，開啟「寵物抽獎券任務」入口。
- 任務顯示於 **每日任務區塊上方**，以獨立卡片顯示，不與每日任務進度共享。

### 2.2 任務目標公式
- 當前目標：
```

target = (idlePerSec \* 60 \* 60 \* 48 \* (1 + k)) + 200

````
- `idlePerSec`：生成目標當下的被動收益快照（不會隨升級動態變動）。
- `k`：任務完成次數累加因子，初始為 0，每次成功領取後 +0.05。
- 固定額外加成：+200。
- 任務完成後立即產生新任務，並計算新的目標。

### 2.3 領取與獎勵
- 任務完成時：
- 顯示「領取」按鈕（必須手動點擊）。
- 點擊領取 → 基礎獎勵 **1 張抽獎券**。
- 領取時可選擇觀看假廣告（3 秒流程），若觀看 → 本次獎勵改為 **2 張抽獎券**。
- 領取後：
- 任務結算 → 新任務立即生成（依公式計算新的 target）。
- `k` 值累加。

### 2.4 抽獎券數量顯示
- 主畫面上方 UI：
- 左側顯示「彩票 icon」：`assets/images/icon/Lottery.png`
- 右側文字顯示當前抽獎券數量。
- 數值即時更新。

### 2.5 存檔結構
在 `game_state_v{save_version}` 中新增：
```json
{
"petTicketQuest": {
  "k": 0.0,
  "target": 0.0,
  "progress": 0.0,
  "idleSnapshot": 0.0,
  "available": false
},
"petTickets": 0
}
````

* `k`：當前累加因子。
* `target`：本次目標。
* `progress`：目前已累積的能量進度。
* `idleSnapshot`：生成目標時的 `idlePerSec`。
* `available`：是否已解鎖（需完成 mainline.stage3）。
* `petTickets`：玩家當前持有的抽獎券數量。

---

## 3. 驗收標準

* ✅ **目標計算正確**：第一次目標 = `idlePerSec * 60 * 60 * 48 * (1 + 0) + 200`；完成後 `k=0.05`，下一次目標正確更新。
* ✅ **領取機制**：完成後需手動點擊領取，否則不會發放抽獎券。
* ✅ **廣告翻倍**：選擇觀看假廣告時，發放 2 張而非 1 張。
* ✅ **持續任務生成**：領取後立即刷新新任務，進度歸 0，並依新 `k` 計算目標。
* ✅ **階段解鎖**：在完成「動物迷因階段」前不會顯示任務區塊，完成後顯示。
* ✅ **首頁顯示**：首頁上方正確顯示當前持有抽獎券數量與彩票 icon。

---

## 4. 實例化需求測試案例

### 案例 1：首次任務生成

* **Given** idlePerSec = 5/s，`k=0`
* **When** 完成「動物迷因階段」
* **Then** 生成任務目標 = `5*60*60*48*1 + 200 = 440`

---

### 案例 2：完成並累加 k

* **Given** 當前任務 target=440，progress=440，k=0
* **When** 玩家完成並領取 1 張抽獎券
* **Then** `k=0.05`，新目標 = `5*60*60*48*1.05 + 200 = 452.4`

---

### 案例 3：廣告翻倍

* **Given** 任務 target=440 已完成
* **When** 玩家選擇觀看廣告流程
* **Then** 抽獎券數量增加 2，非 1

---

### 案例 4：解鎖條件

* **Given** 玩家尚未完成 mainline.stage3
* **When** 開啟首頁
* **Then** 抽獎券任務區塊 **不顯示**

---

### 案例 5：首頁數值更新

* **Given** 玩家當前持有 3 張抽獎券
* **When** 完成任務並領取 1 張
* **Then** 首頁顯示數字更新為 4（或 5 若廣告翻倍）

---

## 5. 限制與備註

* 任務與每日任務（Step 13）獨立，不共享進度或刷新。
* 任務生成的 `idlePerSec` 取快照，不因升級後即時變動。
* 廣告流程目前採 3 秒假流程，後續替換廣告 SDK。
* 本階段僅發放「抽獎券數量」，不包含抽獎介面與結果演出（留待 Step XX）。
